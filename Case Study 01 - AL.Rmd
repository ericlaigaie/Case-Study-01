---
title: "Case Study - 01"
author: "Eric Laigaie & Alex Lopez"
date: "10/5/2021"
output: html_document
---
### Introduction:   In this presentation, we will be looking at the locations of the breweries making beers, beer alcohol content, and beer international bitterness units. After reviewing the data, we will then look at how ABV and IBU can be used to identify whether or not a beer is an IPA or another type of Ale. Finally, we will dive into one other inference that we believe will help you decide what type of beer Budweiser should be producing.


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, fig.width = 6, fig.height = 5)
library(tidyverse)
library(readr)
library(ggplot2)
library(class)
library(caret)
library(e1071)
```

```{r}
beers = read.csv('/Users/alexanderlopez/Documents/SMU/Classes/MSDS_6306_Doing_Data_Science/Case_Study_1/Case-Study-01/Beers.csv', header = TRUE)
breweries = read.csv('/Users/alexanderlopez/Documents/SMU/Classes/MSDS_6306_Doing_Data_Science/Case_Study_1/Case-Study-01/Breweries.csv', header = TRUE)
```

1.   How many breweries are present in each state?
```{r}
# Creating a bar plot to visualize brewery count by state
breweries %>% group_by(State) %>% mutate(n=n()) %>% ggplot(aes(y=reorder(State,n))) + geom_bar(width = .33, fill = 'darkseagreen4')+ geom_text(stat='count', aes(label=..count..), vjust=.33, hjust=-.1) + labs(title = 'Number of Breweries Per State', x = 'Number of Breweries',y = 'State')
```

2.   Merge beer data with the breweries data. Print the first 6 observations and the last six observations to check the merged file.  (RMD only, this does not need to be included in the presentation or the deck.)
```{r}
# First, review the data sets
summary(beers)
summary(breweries)

# Merge needs to be done on the Brew_ID column
# Need to first make brewery id column names the same
names(beers)[5] = 'Brew_ID'
df = merge(beers,breweries,"Brew_ID",suffixes = c('_Beers','_Brewery'))

# Printing head (first 6) and tail (last 6) observations
head(df,6)
tail(df,6)
```

3.   Address the missing values in each column.
```{r}
# There are missing values in both ABV (alcohol by volume) and IBU (international bitterness unit)
# 62 NA values for ABV (62/2410 = 3%)
# 1005 NA values for IBU (1005/2410 = 42%)
# Quick web search indicates that beers can have 0 ABV and IBU
# Assume NA values equal to 0 to avoid removing approx. 40% of data
# Change Na's to 0
df$ABV[is.na(df$ABV)] = 0
df$IBU[is.na(df$IBU)] = 0

# Final check reveals there are 5 NA char values in Style Column
# Since there are only 5 NA values (5/2410 = 0.2%), observations will be dropped
sum(is.na(df))
sum(is.na(df$Style))

# Dropping remaining NA values
df = na.omit(df)
```

4.   Compute the median alcohol content and international bitterness unit for each state. Plot a bar chart to compare.
```{r}
# Group_by State and then plot the medians of ABV and IBU.

df %>% group_by(State) %>% dplyr::summarize(med_abv = median(ABV)) %>% ggplot(aes(x=reorder(State, med_abv),y=med_abv,fill=State)) + geom_bar(stat="identity",width = .33) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=.1), aspect.ratio=9/16) + labs(title = 'Median ABV per State',x='State', y = 'ABV (Alcohol by Volume)')

df %>% group_by(State) %>% dplyr::summarize(med_ibu = median(IBU)) %>% ggplot(aes(x=reorder(State, med_ibu),y=med_ibu,fill=State)) + geom_bar(stat="identity",width = .33) + theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=.1), aspect.ratio=9/16) + labs(title = 'Median IBU per State',x='State', y = 'IBU (International Bitterness Units)')

# Since there were so many Beers with 0 IBU, the mean may give better insight(?)

# Reviewing State means for IBU
df %>% group_by(State) %>% dplyr::summarize(mean_ibu = mean(IBU)) %>% ggplot(aes(y=reorder(State, mean_ibu),x=mean_ibu)) + geom_bar(stat="identity", fill='darkseagreen4') + labs(title = 'Avg IBU per State',y='State', x = 'IBU (International Bitterness Units)')

```

5.   Which state has the maximum alcoholic (ABV) beer? Which state has the most bitter (IBU) beer?

Ans.    The state with the highest alcohol by volume beer is Colorado. The state with the most bitter beer is Oregon. 

```{r}

# Function which.max will give max value for specified column.

df[which.max(df$ABV),] # Beer_ID = 2565
df[which.max(df$IBU),] # Beer_ID = 980

```

6.   Comment on the summary statistics and distribution of the ABV variable.

Ans.   The summary stats would indicate a semi-normal distribution seeing that the mean and medium are fairly similar. The histograms and box plots also show signs of a normal distribution but with a right (positive) skew. The histogram appears more "normal" once the non-alcoholic beers are filtered out of the data set.
```{r}

# First, review the 5 number summary and std values for ABV.

summary(df$ABV)
sd(df$ABV)

# Histograms
df %>% ggplot(aes(x=ABV)) + geom_histogram(bins = 50,fill='blue') + labs(title = 'Histogram of ABV')

# Non-alcoholic beers appear to be negative outliers and should be removed if we are to analyze beer ABV.

df %>% filter(ABV>0) %>% ggplot(aes(x=ABV)) + geom_histogram(bins = 40,fill='blue') + labs(title = 'Histogram of ABV (excluding non-alcoholic)')

# Box Plots
df %>%  ggplot(aes(y=ABV)) + geom_boxplot(fill='blue') + labs(title = 'Histogram of ABV')

df %>% filter(ABV>0) %>% ggplot(aes(y=ABV)) + geom_boxplot(fill='blue') + labs(title = 'Histogram of ABV (excluding non-alcoholic)')

# Non-alcoholic beers do not seem as apparent in box plots.

```

7.   Is there an apparent relationship between the bitterness of the beer and its alcoholic content? Draw a scatter plot.  Make your best judgment of a relationship and EXPLAIN your answer.

Ans.    Looking at the scatter plot and smooth fit line, there is visual evidence of a positive correlation between ABV and IBU.
```{r}

# Using all data points
df %>% ggplot(aes(x=ABV,y=IBU)) + geom_point() + labs(title = 'ABV vs IBU')

# Excluding beers with IBU = 0
df %>% filter(IBU>0) %>% ggplot(aes(x=ABV,y=IBU)) + geom_point(color='red') + geom_smooth(method = 'lm') + labs(title = 'ABV vs IBU')

```

8.  Budweiser would also like to investigate the difference with respect to IBU and ABV between IPAs (India Pale Ales) and other types of Ale (any beer with “Ale” in its name other than IPA).  You decide to use KNN classification to investigate this relationship.  Provide statistical evidence one way or the other. You can of course assume your audience is comfortable with percentages … KNN is very easy to understand conceptually.

Ans. 
```{r}

# Create new data frame with only Ale and IPA Beers
# Next, create dummy variable for Ale vs IPA

df_ale = df %>% filter(str_detect(Style,"Ale"))
df_IPA = df %>% filter(str_detect(Style,"IPA"))

new_df = rbind.data.frame(df_ale,df_IPA)

new_df$ale_IPA = grepl("Ale",new_df$Style)

new_df$ale_IPA[new_df$ale_IPA == 'TRUE'] = 'Ale'
new_df$ale_IPA[new_df$ale_IPA == 'FALSE'] = 'IPA'
new_df$ale_IPA = as.factor(new_df$ale_IPA)

# Perform KNN model using ABV and IBU
# Hyper-tune to be completed on K value

# First, standardize IBU and ABV values

new_df$zABV = as.numeric(scale(new_df$ABV))
new_df$zIBU = as.numeric(scale(new_df$IBU))

# Create 70/30 Train/Test Split
trainInd = sample(seq(1,1547,1), .7*1547)
train = new_df[trainInd,]
test = new_df[-trainInd,]

# Initial run of KNN model with K=5 
classifications = knn(train[,c(12,13)],test[,c(12,13)],train$ale_IPA,prob = TRUE, k = 5)
confusionMatrix(table(classifications,test$ale_IPA))

# Loop to find best value for K with 70/30 train-test split

iterations = 100
numks = 100
splitPerc = .70

masterAcc = matrix(nrow = iterations, ncol = numks)
masterSen = matrix(nrow = iterations, ncol = numks)
masterSpe = matrix(nrow = iterations, ncol = numks)

for(j in 1:iterations)
{
  trainIndices = sample(1:dim(new_df)[1],round(splitPerc * dim(new_df)[1]))
  train = new_df[trainIndices,]
  test = new_df[-trainIndices,]
  for(i in 1:numks)
  {
    classifications = knn(train[,c(12,13)],test[,c(12,13)],train$ale_IPA, prob = TRUE, k = i)
    table(classifications,test$ale_IPA)
    CM = confusionMatrix(table(classifications,test$ale_IPA))
    masterAcc[j,i] = CM$overall[1]
    masterSen[j,i] = CM$byClass[1]
    masterSpe[j,i] = CM$byClass[2]
  }
  
}

MeanAcc = colMeans(masterAcc)
MeanSen = colMeans(masterSen)
MeanSpe = colMeans(masterSpe)

plot(seq(1,numks,1),MeanAcc, type = "l")
which.max(MeanAcc)
max(MeanAcc)

plot(seq(1,numks,1),MeanSen, type = "l")
which.max(MeanSen)
max(MeanSen)

plot(seq(1,numks,1),MeanSpe, type = "l")
which.max(MeanSpe)
max(MeanSpe)

# K = 6 gives highest accuracy (81%)
# K = 10 gives highest sensitivity (87%)
# K = 62 gives highest specificity (73%)

# Run KNN model with K=6 for highest accuracy (per hyper tuning)
classifications = knn(train[,c(12,13)],test[,c(12,13)],train$ale_IPA,prob = TRUE, k = 6)
confusionMatrix(table(classifications,test$ale_IPA))

```

In addition, while you have decided to use KNN to investigate this relationship (KNN is required) you may also feel free to supplement your response to this question with any other methods or techniques you have learned.  Creativity and alternative solutions are always encouraged.
```{r}
# Using Naive-Bayes to investigate relationship

# Set seed and create Train/Test Split 
set.seed(10)
trainIndices = sample(seq(1:length(new_df$Beer_ID)),round(.7*length(new_df$Beer_ID)))
train_nb = new_df[trainIndices,]
test_nb = new_df[-trainIndices,]

# Create model and print confusion matrix
model = naiveBayes(train_nb[,c(12,13)],train_nb$ale_IPA,laplace = 1)
table(predict(model,test_nb[,c(12,13)]),test_nb$ale_IPA)
CM = confusionMatrix(table(predict(model,test_nb[,c(12,13)]),test_nb$ale_IPA))
CM


```

9. Knock their socks off!  Find one other useful inference from the data that you feel Budweiser may be able to find value in.  You must convince them why it is important and back up your conviction with appropriate statistical evidence.
```{r}
# ideas: 
# group states into regions and find the parameters for most common beer per region(mean abv/ibu?)
# removing 0 values from data and then re-running models - only looking at alcoholic/bitter beers
# clustering?
# impute IBU with mean or median and rerun models? 
# create groups for ibu and abv (low, median, high) and see what types of beers are the most popular. Per state?
```

```{r}
# create copy of original df to try different impute method
new_df2 = merge(beers,breweries,"Brew_ID",suffixes = c('_Beers','_Brewery'))

new_df2$Ale = grepl("Ale",new_df2$Style)
new_df2$IPA = grepl("IPA",new_df2$Style)
new_df2$Lager = grepl("Lager",new_df2$Style)
new_df2$Stout = grepl("Stout",new_df2$Style)
new_df2$Other = as.logical(ifelse(new_df2$Ale + new_df2$IPA + new_df2$Lager + new_df2$Stout == 0, "TRUE","FALSE"))

new_df2$Style_Type = as.factor(names(new_df2[11:15])[max.col(new_df2[11:15])])

```

